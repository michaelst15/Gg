# === Metadata Audit ===
$auditName = "CIS_5.1_Maximum_Number_Of_Error_Log_Files"
$cisExpectedValue = "Maximum number of error log files >= 12"

# Folder & File Output
$outputFolder = "C:\hardening_SQLServer2008\Audit"
$outputFile = Join-Path $outputFolder "$auditName.txt"

if (-not (Test-Path $outputFolder)) {
    New-Item -Path $outputFolder -ItemType Directory | Out-Null
}

# Query SQL
$sqlQuery = @"
DECLARE @NumErrorLogs INT;
EXEC master.sys.xp_instance_regread
    N'HKEY_LOCAL_MACHINE',
    N'Software\Microsoft\MSSQLServer\MSSQLServer',
    N'NumErrorLogs',
    @NumErrorLogs OUTPUT;
SELECT ISNULL(@NumErrorLogs, -1) AS NumberOfLogFiles;
"@

# Server & Login (gunakan SQL Authentication)
$server = "IDITG12040"
$user = "dbidadmin"
$password = "zMAaFdF9G38dER"

# Jalankan sqlcmd dan ambil output
try {
    $rawOutput = sqlcmd -S $server -U $user -P $password -Q $sqlQuery -h -1 -W 2>&1
} catch {
    Write-Host "Gagal menjalankan sqlcmd: $_"
    exit
}

# Ambil hanya baris yang berisi angka, lalu konversi ke int
$numErrorLogs = $rawOutput | ForEach-Object { $_.Trim() } | Where-Object { $_ -match '^\d+$' } | Select-Object -First 1
$numErrorLogs = [int]$numErrorLogs

# Evaluasi hasil audit
if ($numErrorLogs -ge 12) {
    $statusAudit = "Pass"
    $currentValue = "Maximum number of error log files saat ini adalah $numErrorLogs, memenuhi ketentuan CIS (>= 12)."
} elseif ($numErrorLogs -eq -1) {
    $statusAudit = "Fail"
    $currentValue = "Tidak ditemukan nilai konfigurasi 'NumErrorLogs' di registry SQL Server."
} else {
    $statusAudit = "Fail"
    $currentValue = "Maximum number of error log files saat ini adalah $numErrorLogs, kurang dari ketentuan CIS (>= 12)."
}

# Susun laporan
$report = @"
Judul Audit         : $auditName
Status              : $statusAudit
Nilai Konfigurasi   : $currentValue
Nilai Ketetapan CIS : $cisExpectedValue

Deskripsi:
SQL Server error log files harus disimpan minimal 12 file untuk mencegah kehilangan data penting akibat daur ulang log yang terlalu cepat.

Audit:
Query membaca nilai NumErrorLogs dari registry SQL Server menggunakan prosedur xp_instance_regread.

Impact:
Menjaga jumlah error log minimal 12 membantu menjaga rekaman peristiwa penting server dan login.

Default Value:
Default SQL Server biasanya menyimpan 6 error log files, kurang dari ketentuan CIS.
"@

# Simpan laporan
$report | Out-File -FilePath $outputFile -Encoding UTF8
Write-Host "Audit selesai. Laporan tersimpan di: $outputFile"
