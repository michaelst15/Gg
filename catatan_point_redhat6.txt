# ==============================================
# Audit Versi SQL Server 2008 Menggunakan sqlcmd
# File : audit_sqlversion_sqlcmd.ps1
# ==============================================

# Parameter koneksi
$serverName = "IDITG12040"            # Nama server atau IP
$userName   = "dbidadmin"             # User SQL
$password   = "zMAaFdF9G38dER"        # Password SQL

# Nilai ketetapan CIS (standar)
$cisSPExpected      = "SP2"
$cisVersionExpected = "10.50.4000.0"

# Folder output
$folderPath = "C:\hardening_SQLServer2008\Audit"
if (-not (Test-Path $folderPath)) {
    Write-Host "Membuat folder output: $folderPath"
    New-Item -Path $folderPath -ItemType Directory | Out-Null
}

$auditName = "CIS_1.1_SQLVersion"
$outputTxt = Join-Path $folderPath "$auditName.txt"

# Perintah SQL untuk di-eksekusi
$sqlQuery = "SET NOCOUNT ON; SELECT SERVERPROPERTY('ProductLevel') AS SP_installed, SERVERPROPERTY('ProductVersion') AS Version;"

# Menjalankan sqlcmd
try {
    $sqlcmdOutput = & sqlcmd -S $serverName -U $userName -P $password -Q $sqlQuery -h -1 -W

    if (-not $sqlcmdOutput) {
        Write-Host "❌ Tidak ditemukan data versi SQL Server."
        $status = "Error"
        $configSP = "<tidak ditemukan>"
        $configVersion = "<tidak ditemukan>"
    } else {
        # Hasil dipisah berdasarkan spasi/tap
        $columns = $sqlcmdOutput -split "\s+"
        $configSP      = $columns[0]
        $configVersion = $columns[1]

        if (($configSP -eq $cisSPExpected) -and ($configVersion -eq $cisVersionExpected)) {
            $status = "Pass"
        } else {
            $status = "Fail"
        }
    }

    # Buat konten output
    $outputContent = @"
Judul Audit         : $auditName
Status              : $status
Nilai Konfigurasi   : SP_installed: $configSP; Version: $configVersion
Nilai Ketetapan CIS : SP_installed: $cisSPExpected; Version: $cisVersionExpected
"@

    # Simpan hasil ke file
    $outputContent | Out-File -FilePath $outputTxt -Encoding UTF8
    Write-Host "`n✅ File audit berhasil dibuat di: $outputTxt"
}
catch {
    Write-Error "Koneksi atau eksekusi sqlcmd gagal: $_"
}
