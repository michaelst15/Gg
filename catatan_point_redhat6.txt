# === Metadata ===
$auditName = "CIS_7.1_SymmetricKey_Uses_AES128_Or_Higher"
$cisExpectedValue = "Semua symmetric key di database non-sistem menggunakan AES_128, AES_192, atau AES_256"

# Output
$outputFolder = "C:\hardening_SQLServer2008\Audit"
$outputFile = Join-Path $outputFolder "$auditName.txt"
if (-not (Test-Path $outputFolder)) { New-Item -Path $outputFolder -ItemType Directory | Out-Null }

# Koneksi SQL (gunakan sqlcmd)
$sqlServer = "IDITG12040"
$sqlUser   = "dbidadmin"
$sqlPass   = "zMAaFdF9G38dER"

# 1️⃣ Ambil semua user database
$dbListCmd = @"
SET NOCOUNT ON;
SELECT name FROM sys.databases WHERE database_id > 4;
"@

try {
    $userDatabases = & sqlcmd -S $sqlServer -U $sqlUser -P $sqlPass -Q $dbListCmd -h -1 -W 2>&1
} catch {
    Write-Host "❌ Gagal menjalankan sqlcmd: $_"
    exit
}

# Pastikan tidak null dan buang baris kosong
if (-not $userDatabases) {
    $userDatabases = @()
} else {
    $userDatabases = $userDatabases | ForEach-Object { $_.Trim() } | Where-Object { $_ -ne "" }
}

$nonCompliantKeys = @()

# 2️⃣ Loop setiap database dan cek symmetric key
foreach ($dbName in $userDatabases) {
    $checkKeysCmd = @"
USE [$dbName];
SET NOCOUNT ON;
SELECT '$dbName' AS Database_Name, name AS Key_Name, algorithm_desc
FROM sys.symmetric_keys
WHERE algorithm_desc NOT IN ('AES_128','AES_192','AES_256');
"@

    try {
        $result = & sqlcmd -S $sqlServer -U $sqlUser -P $sqlPass -Q $checkKeysCmd -s "|" -W -h -1 2>&1
    } catch {
        Write-Host "⚠️ Gagal memeriksa database $dbName: $_"
        continue
    }

    if ($result) {
        foreach ($line in $result) {
            if ($line.Trim() -ne "") {
                $parts = $line -split "\|"
                if ($parts.Count -ge 3) {
                    $nonCompliantKeys += [PSCustomObject]@{
                        Database  = $parts[0].Trim()
                        KeyName   = $parts[1].Trim()
                        Algorithm = $parts[2].Trim()
                    }
                }
            }
        }
    }
}

# 3️⃣ Evaluasi hasil
if ($nonCompliantKeys.Count -eq 0) {
    $statusAudit = "Pass"
    $currentValue = "Semua symmetric key di semua database non-sistem menggunakan AES_128 atau lebih tinggi."
} else {
    $statusAudit = "Fail"
    $detail = $nonCompliantKeys | Format-Table -AutoSize | Out-String
    $currentValue = "Ditemukan symmetric key yang tidak sesuai:`n$detail"
}

# 4️⃣ Susun laporan
$report = @"
Judul Audit         : $auditName
Status              : $statusAudit
Nilai Konfigurasi   : $currentValue
Nilai Ketetapan CIS : $cisExpectedValue

Deskripsi:
Audit ini memverifikasi bahwa semua symmetric key pada user database menggunakan algoritma AES_128, AES_192, atau AES_256.

Remediation:
ALTER SYMMETRIC KEY <nama_key> REGENERATE WITH ALGORITHM = AES_256;
"@

# 5️⃣ Simpan hasil
$report | Out-File -FilePath $outputFile -Encoding UTF8
Write-Host "✅ Audit selesai. Laporan tersimpan di: $outputFile"
