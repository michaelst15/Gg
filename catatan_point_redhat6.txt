#!/bin/bash

# === Konfigurasi ===
output_file="remediation_result.txt"
judul="Pemulihan Konfigurasi: CIS 5.2.2 Ensure sudo commands use pty"
sudoers_file="/etc/sudoers"

# === Awal eksekusi ===
{
    echo "================================================================================"
    echo "$judul"
    echo "🕒 Waktu Eksekusi: $(date)"
    echo
    echo "📋 Tindakan:"
} >> "$output_file"

# === 1. Hapus entri 'Defaults use_pty' dari /etc/sudoers ===
if grep -Eq '^\s*Defaults\s+.*\buse_pty\b' "$sudoers_file"; then
    cp -p "$sudoers_file" "${sudoers_file}.bak_$(date +%Y%m%d%H%M%S)"
    sed -i '/^\s*Defaults\s\+.*\buse_pty\b/d' "$sudoers_file"
    if visudo -cf "$sudoers_file" >/dev/null 2>&1; then
        echo "- Baris 'Defaults use_pty' dihapus dari $sudoers_file" >> "$output_file"
    else
        echo "❌ Kesalahan validasi sudoers! Memulihkan dari backup..." >> "$output_file"
        cp -p "${sudoers_file}.bak_$(date +%Y%m%d%H%M%S)" "$sudoers_file"
    fi
else
    echo "- Tidak ditemukan entri 'Defaults use_pty' di $sudoers_file" >> "$output_file"
fi

# === 2. Hapus dari /etc/sudoers.d/ ===
restored_d_files=()
for file in /etc/sudoers.d/*; do
    [[ -f "$file" ]] || continue
    if grep -Eq '^\s*Defaults\s+.*\buse_pty\b' "$file"; then
        sed -i '/^\s*Defaults\s\+.*\buse_pty\b/d' "$file"
        restored_d_files+=("$file")
    fi
done

if ((${#restored_d_files[@]})); then
    echo "- Entri 'Defaults use_pty' juga dihapus dari file:" >> "$output_file"
    for f in "${restored_d_files[@]}"; do
        echo "  - $f" >> "$output_file"
    done
else
    echo "- Tidak ada entri 'Defaults use_pty' di /etc/sudoers.d/" >> "$output_file"
fi

# === 3. Akhiri log ===
{
    echo
    echo "🔎 Status Akhir: Sudah Diperbaiki"
    echo "================================================================================"
    echo
} >> "$output_file"

echo "✅ Pemulihan selesai. Log dicatat di: $output_file"
