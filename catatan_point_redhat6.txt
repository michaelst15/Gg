# Audit Name dan Nilai Ketetapan CIS
$auditName = "CIS_4.3_CHECK_POLICY_ON_For_SQL_Authenticated_Logins"
$cisExpectedValue = "CHECK_POLICY = ON untuk semua SQL Authenticated Logins yang aktif"

# Output Folder dan File
$outputFolder = "C:\hardening_SQLServer2008\Audit"
$outputFile = Join-Path $outputFolder "$auditName.txt"

if (-not (Test-Path $outputFolder)) {
    New-Item -Path $outputFolder -ItemType Directory | Out-Null
}

# Parameter koneksi
$sqlServer = "IDITG12040"
$sqlUser   = "dbidadmin"
$sqlPass   = "zMAaFdF9G38dER"

# Query untuk audit
$sqlQuery = @"
SET NOCOUNT ON;
SELECT name, is_disabled
FROM sys.sql_logins
WHERE is_policy_checked = 0
AND is_disabled = 0;
"@

# Buat file sementara manual (kompatibel PowerShell 2.0)
$tempFile = Join-Path $env:TEMP ("sql_audit_" + (Get-Random) + ".sql")
$sqlQuery | Out-File -FilePath $tempFile -Encoding ASCII

# Jalankan query menggunakan sqlcmd
try {
    $rawOutput = & sqlcmd -S $sqlServer -U $sqlUser -P $sqlPass -i $tempFile -h -1 -W 2>&1
} catch {
    Write-Host "Error menjalankan sqlcmd: $_"
    exit
} finally {
    if (Test-Path $tempFile) {
        Remove-Item $tempFile -Force
    }
}

# Parsing hasil
$failedLogins = @()
foreach ($line in $rawOutput) {
    if (-not [string]::IsNullOrWhiteSpace($line) -and $line -notmatch "----") {
        $cols = $line -split "\s{2,}"
        if ($cols.Count -ge 2) {
            $failedLogins += [PSCustomObject]@{
                LoginName  = $cols[0]
                IsDisabled = $cols[1]
            }
        }
    }
}

# Susun hasil audit
if ($failedLogins.Count -eq 0) {
    $statusAudit = "Pass"
    $currentValue = "Semua SQL Authenticated Logins yang aktif memiliki CHECK_POLICY = ON"
} else {
    $statusAudit = "Fail"
    $failedDetail = $failedLogins | Format-Table -AutoSize | Out-String
    $currentValue = "Beberapa SQL Authenticated Logins yang aktif tidak memiliki CHECK_POLICY = ON:`n$failedDetail"
}

# Susun laporan
$report = @"
Judul Audit         : $auditName
Status              : $statusAudit
Nilai Konfigurasi   : $currentValue
Nilai Ketetapan CIS : $cisExpectedValue

Deskripsi:
Opsi CHECK_POLICY harus di-set ke ON untuk semua SQL Authenticated Logins yang aktif agar password login tersebut memenuhi kebijakan kompleksitas password Windows.

Audit:
Query di atas mencari SQL Authenticated Logins yang aktif dengan CHECK_POLICY = OFF.

Impact:
Dengan CHECK_POLICY ON, password login harus memenuhi persyaratan kompleksitas sehingga meningkatkan keamanan.

Default Value:
Jika tidak diatur, CHECK_POLICY biasanya OFF secara default saat membuat login lewat T-SQL.
"@

# Simpan laporan
$report | Out-File -FilePath $outputFile -Encoding UTF8
Write-Host "Audit selesai. Laporan tersimpan di: $outputFile"
