#!/bin/bash

# === Konfigurasi ===
conf_file="/etc/modprobe.d/usb_storage.conf"
backup_file="/etc/modprobe.d/usb_storage.conf.bak"
output_file="remediation_result.txt"
mod_status_file="usb_module_status_before_delete.txt"
judul="Restore & Hapus Konfigurasi USB Storage"

echo "📦 Memulai proses restore & hapus konfigurasi USB Storage..."

# Simpan status modul sebelum dihapus
lsmod | grep -w "^usb_storage" > "$mod_status_file" 2>/dev/null
if [[ -s "$mod_status_file" ]]; then
    module_status="Aktif"
    echo "🧩 Modul usb-storage aktif sebelum penghapusan."
else
    module_status="Tidak aktif"
    echo "✅ Modul usb-storage tidak aktif sebelum penghapusan."
fi

# Hapus file konfigurasi
if [[ -f "$conf_file" ]]; then
    rm -f "$conf_file"
    conf_status="Dihapus"
    echo "🗑️ File konfigurasi USB Storage dihapus: $conf_file"
else
    conf_status="Tidak ditemukan"
    echo "ℹ️ File konfigurasi tidak ditemukan: $conf_file"
fi

# Hapus backup jika ada
if [[ -f "$backup_file" ]]; then
    rm -f "$backup_file"
    backup_status="Dihapus"
    echo "🗑️ Backup konfigurasi dihapus: $backup_file"
else
    backup_status="Tidak ditemukan"
    echo "ℹ️ File backup tidak ditemukan: $backup_file"
fi

# Catat log ke file output
{
echo "================================================================================"
echo "$judul"
echo "🕒 Waktu Eksekusi: $(date)"
echo
echo "🔧 Tindakan:"
echo "- File konfigurasi: $conf_file -> $conf_status"
echo "- Backup konfigurasi: $backup_file -> $backup_status"
echo
echo "🔎 Status Modul Sebelum Penghapusan: $module_status"
echo
echo "✅ Status Akhir:"
echo "- File konfigurasi: $conf_status"
echo "- Backup konfigurasi: $backup_status"
echo "- Modul usb-storage: $module_status"
echo "================================================================================"
echo
} >> "$output_file"

echo "📄 Log proses dicatat di: $output_file"
